<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Tribunal des Mythes - Dashboard</title>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; --accent: #6366f1;
            --cat1: #3b82f6; --cat2: #ef4444; --cat3: #a855f7; --cat4: #10b981;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Navigation & Barre d'outils */
        .top-bar { display: flex; gap: 10px; padding: 10px; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(5px); justify-content: center; width: 100%; box-sizing: border-box; }
        .btn-tool { background: #334155; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; font-weight: bold; }

        .tab-content { display: none; flex-direction: column; align-items: center; padding: 20px; flex: 1; overflow-y: auto; }
        .tab-content.active { display: flex; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        
        /* Cartes et Animations */
        #card-container { position: relative; width: 85vw; max-width: 320px; height: 110vw; max-height: 450px; margin: 15px 0; perspective: 1000px; }
        .game-card { position: absolute; inset: 0; background: var(--card-bg); border-radius: 25px; border: 5px solid var(--text); display: flex; flex-direction: column; justify-content: center; padding: 25px; text-align: center; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s; backface-visibility: hidden; }
        .slide-out { transform: translateY(-120%) rotate(-10deg); opacity: 0; }
        .slide-in { transform: translateY(100%); opacity: 0; }
        .active-card { transform: translateY(0) rotate(0deg); opacity: 1; }
        
        /* Cat√©gories */
        .cat-1 { border-color: var(--cat1); } .cat-2 { border-color: var(--cat2); }
        .cat-3 { border-color: var(--cat3); } .cat-4 { border-color: var(--cat4); }

        /* Modaux */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; flex-direction: column; padding: 20px; overflow-y: auto; }
        .modal-content { background: var(--card-bg); border-radius: 20px; padding: 20px; width: 100%; max-width: 400px; margin: auto; }
        
        .player-row { background: #334155; margin: 8px 0; padding: 12px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .power-btn { background: var(--cat4); border: none; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; margin: 2px; }
        .power-btn.used { background: #475569; text-decoration: line-through; opacity: 0.5; }

        #overlay { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 300; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
    </style>
</head>
<body>

<div id="setup-tab" class="tab-content active">
    <h1>Le Tribunal</h1>
    <p>Ajoutez les joueurs</p>
    <input type="text" id="p-name" placeholder="Pr√©nom...">
    <button class="btn-main" onclick="registerPlayer()">AJOUTER JOUEUR</button>
    <div id="list-names" style="margin: 20px 0; display: flex; flex-wrap: wrap; justify-content: center;"></div>
    <button id="config-btn" class="btn-main" style="display:none; background:var(--cat4);" onclick="showRoleConfig()">CONFIGURER LES R√îLES</button>
</div>

<div id="config-tab" class="tab-content">
    <h2>R√¥les Actifs</h2>
    <div id="role-selector-list" style="width: 100%;"></div>
    <button class="btn-main" onclick="validateAndStart()">LANCER LA PARTIE</button>
</div>

<div id="game-tab" class="tab-content" style="padding: 0;">
    <div class="top-bar">
        <button class="btn-tool" onclick="toggleModal('modal-rules', true)">üìñ R√àGLES</button>
        <button class="btn-tool" onclick="toggleModal('modal-players', true)">üë§ JOUEURS</button>
    </div>
    <div id="turn-info" style="margin-top: 15px; font-weight: bold; color: var(--accent);"></div>
    <div id="card-container"></div>
    <button class="btn-main" style="width: 85%;" onclick="drawCardWithAnimation()">PIOCHER</button>
</div>

<div id="modal-rules" class="modal">
    <div class="modal-content">
        <h2>R√®gles du Tribunal</h2>
        <div style="text-align: left; font-size: 0.9rem; line-height: 1.4;">
            <p><strong>‚öñÔ∏è L'Avocat :</strong> Pour les Accusations, un joueur peut d√©fendre l'accus√©. Si le vote √©choue, l'avocat boit double.</p>
            <p><strong>üç∑ Beverage :</strong> Ces cartes ne sont jamais retir√©es du paquet.</p>
            <p><strong>üé≠ R√¥les :</strong> Utilisez vos pouvoirs via le menu "Joueurs".</p>
        </div>
        <button class="btn-main" onclick="toggleModal('modal-rules', false)">FERMER</button>
    </div>
</div>

<div id="modal-players" class="modal">
    <div class="modal-content">
        <h2>Tableau des R√¥les</h2>
        <p style="font-size: 0.7rem; color: gray; margin-bottom: 15px;">Cliquez sur un joueur pour g√©rer son pouvoir</p>
        <div id="player-dashboard"></div>
        <button class="btn-main" onclick="toggleModal('modal-players', false)">RETOUR AU JEU</button>
    </div>
</div>

<div id="overlay">
    <div id="transition-screen">
        <h2 id="next-player-name"></h2>
        <button class="btn-main" onclick="revealRoleNow()">D√âVOILER MON R√îLE</button>
    </div>
    <div id="role-screen" class="role-card" style="display:none; position:relative;">
        <h2 id="overlay-player"></h2>
        <h1 id="overlay-role" style="color:var(--accent);"></h1>
        <p id="overlay-desc"></p>
        <div id="zoz-choice-container" style="display:none; flex-wrap:wrap; justify-content:center; margin-top:10px;"></div>
        <button id="overlay-btn" class="btn-main" onclick="closeOverlay()">OK</button>
    </div>
</div>

<script>
    let players = [];
    let rolesData = {};
    let zozPartners = [];
    let currentIdx = 0;
    let deck = [];
    let isAnimating = false;

    // D√©finition des r√¥les avec limites d'utilisation
    const allRoles = [
        { name: "La D", uses: 2, desc: "Sert un shot √† qui tu veux (2x)." },
        { name: "La Zoz", uses: 0, desc: "Tu es li√© √† ton partenaire. Pas de crasses." },
        { name: "La Sainte Marie", uses: 3, desc: "Trouve les Zoz. 3 essais max." },
        { name: "L'Aveugle", uses: 2, desc: "Sert un verre dos√© √† l'aveugle (2x)." },
        { name: "Cloche Br√©silienne", uses: 2, desc: "Emp√™che quelqu'un de boire (2x)." },
        { name: "Le Cacapitaine", uses: 2, desc: "Change le destinataire d'un verre (2x)." },
        { name: "Le Opps", uses: 0, desc: "Aide la Sainte Marie sans te faire griller." },
        { name: "Paf", uses: 2, desc: "Dis PAF sur un 'Distribue' et choisis les cibles (2x)." },
        { name: "Le Kamikaze", uses: 1, desc: "TIC-TAC : 10s pour finir. √âchec = Cul-sec (1x)." }
    ];

    const duplicatableNames = ["La D", "L'Aveugle", "Cloche Br√©silienne", "Le Cacapitaine", "Paf", "Le Kamikaze"];

    const baseCards = [
        {cat:1, text:"Qui est le plus mauvais conducteur ?"},
        {cat:1, text:"Qui texterait son ex apr√®s 3 verres ?"},
        {cat:1, text:"Qui dispara√Æt sans pr√©venir pour dormir ?"},
        {cat:2, text:"Bois 3 gorg√©es"}, {cat:2, text:"Distribue 1 shot"},
        {cat:3, text:"√éle d√©serte. Mariage, une nuit, ou sacrifice ?"},
        {cat:4, text:"Sniper : POUCE ! Le dernier boit 3."}
        // ... (Toutes les autres cartes du fichier texte)
    ];

    function registerPlayer() {
        const name = document.getElementById('p-name').value.trim();
        if(name) { players.push(name); document.getElementById('p-name').value = ""; renderNames(); }
    }

    function renderNames() {
        document.getElementById('list-names').innerHTML = players.map(p => `<span class="player-tag">${p}</span>`).join('');
        document.getElementById('config-btn').style.display = players.length >= 2 ? 'block' : 'none';
    }

    function showRoleConfig() {
        document.getElementById('setup-tab').classList.remove('active');
        document.getElementById('config-tab').classList.add('active');
        const list = document.getElementById('role-selector-list');
        list.innerHTML = allRoles.map((r, i) => `
            <div style="display:flex; justify-content:space-between; background:#1e293b; padding:10px; margin:5px; border-radius:8px;">
                <label>${r.name}</label>
                <input type="checkbox" id="role-${i}" checked>
            </div>
        `).join('');
    }

    function validateAndStart() {
        let pool = [];
        allRoles.forEach((r, i) => { if(document.getElementById(`role-${i}`).checked) pool.push({...r, currentUses: 0}); });
        
        // Distribution
        let rolesToAssign = [...pool].sort(() => 0.5 - Math.random()).slice(0, players.length);
        while(rolesToAssign.length < players.length) {
            let dup = {...allRoles.find(r => duplicatableNames.includes(r.name))};
            rolesToAssign.push({...dup, currentUses: 0});
        }

        let finalMapping = new Array(players.length).fill(null);
        let pIdx = Array.from({length: players.length}, (_, i) => i);
        let zoz = rolesToAssign.find(r => r.name === "La Zoz");
        let opps = rolesToAssign.find(r => r.name === "Le Opps");

        if(zoz && opps) {
            let zIdx = Math.floor(Math.random() * (players.length - 1));
            finalMapping[zIdx] = zoz; rolesToAssign.splice(rolesToAssign.indexOf(zoz), 1);
            pIdx.splice(pIdx.indexOf(zIdx), 1);
            let oppsIdx = pIdx.filter(i => i > zIdx)[0] || pIdx[0];
            finalMapping[oppsIdx] = opps; rolesToAssign.splice(rolesToAssign.indexOf(opps), 1);
            pIdx.splice(pIdx.indexOf(oppsIdx), 1);
        }

        rolesToAssign.sort(() => 0.5 - Math.random());
        pIdx.forEach((idx, i) => finalMapping[idx] = rolesToAssign[i]);
        players.forEach((p, i) => rolesData[p] = finalMapping[i]);

        currentIdx = 0;
        document.getElementById('overlay').style.display = 'flex';
        prepareTransition();
    }

    function toggleModal(id, show) {
        document.getElementById(id).style.display = show ? 'flex' : 'none';
        if(id === 'modal-players' && show) updateDashboard();
    }

    function updateDashboard() {
        const dash = document.getElementById('player-dashboard');
        dash.innerHTML = players.map(p => {
            const r = rolesData[p];
            let powerHtml = '';
            if(r.uses > 0) {
                for(let i = 1; i <= r.uses; i++) {
                    const isUsed = r.currentUses >= i;
                    powerHtml += `<button class="power-btn ${isUsed ? 'used' : ''}" onclick="usePower('${p}', ${i})">Utilisation ${i}</button>`;
                }
            }
            return `
                <div class="player-row">
                    <div style="text-align:left">
                        <strong>${p}</strong><br>
                        <small style="color:var(--accent)">${r.name}</small>
                    </div>
                    <div>${powerHtml}</div>
                </div>
            `;
        }).join('');
    }

    function usePower(playerName, useNumber) {
        if(rolesData[playerName].currentUses < useNumber) {
            rolesData[playerName].currentUses = useNumber;
            updateDashboard();
        }
    }

    // --- LOGIQUE DE JEU & ANIMATION ---
    function prepareTransition() {
        document.getElementById('role-screen').style.display = 'none';
        document.getElementById('transition-screen').style.display = 'flex';
        document.getElementById('next-player-name').innerText = "Au tour de : " + players[currentIdx];
    }

    function revealRoleNow() {
        const name = players[currentIdx];
        const data = rolesData[name];
        document.getElementById('transition-screen').style.display = 'none';
        document.getElementById('role-screen').style.display = 'block';
        document.getElementById('overlay-player').innerText = name;
        document.getElementById('overlay-role').innerText = data.name;
        document.getElementById('overlay-desc').innerText = data.desc;
        if(data.name === "La Zoz") {
            document.getElementById('overlay-btn').style.display = "none";
            document.getElementById('zoz-choice-container').style.display = "flex";
            document.getElementById('zoz-choice-container').innerHTML = players.map(p => `<button class="zoz-btn" onclick="selectZoz('${p}')">${p}</button>`).join('');
        } else if(data.name === "Le Opps") {
            document.getElementById('overlay-desc').innerText += `\n\nLES ZOZ SONT : ${zozPartners.join(" et ")}`;
        }
    }

    function selectZoz(p) {
        if(zozPartners.includes(p)) zozPartners = zozPartners.filter(x => x !== p);
        else if(zozPartners.length < 2) zozPartners.push(p);
        document.getElementById('overlay-btn').style.display = (zozPartners.length === 2) ? "block" : "none";
    }

    function closeOverlay() {
        document.getElementById('zoz-choice-container').innerHTML = "";
        currentIdx++;
        if(currentIdx < players.length) prepareTransition();
        else {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('config-tab').classList.remove('active');
            document.getElementById('game-tab').classList.add('active');
            deck = [...baseCards]; currentIdx = 0; spawnInitialCard();
        }
    }

    function spawnInitialCard() {
        const container = document.getElementById('card-container');
        const card = getNextCardData();
        const cardEl = createCardElement(card);
        cardEl.classList.add('active-card');
        container.appendChild(cardEl);
        document.getElementById('turn-info').innerText = "Tour de : " + players[currentIdx];
    }

    function createCardElement(data) {
        const el = document.createElement('div');
        el.className = `game-card cat-${data.cat}`;
        const labels = ["", "ACCUSATION", "BEVERAGE", "PACTE DU DIABLE", "D√âFI FLASH"];
        el.innerHTML = `<div style="font-size:0.7rem;opacity:0.6;margin-bottom:10px">${labels[data.cat]}</div><div style="font-size:1.3rem;font-weight:bold">${data.text}</div>`;
        return el;
    }

    function getNextCardData() {
        if(deck.length === 0) deck = [...baseCards];
        const rIdx = Math.floor(Math.random() * deck.length);
        const card = deck[rIdx];
        if(card.cat !== 2) deck.splice(rIdx, 1);
        return card;
    }

    function drawCardWithAnimation() {
        if(isAnimating) return;
        isAnimating = true;
        const container = document.getElementById('card-container');
        const oldCard = container.querySelector('.active-card');
        currentIdx = (currentIdx + 1) % players.length;
        const nextData = getNextCardData();
        const newCard = createCardElement(nextData);
        newCard.classList.add('slide-in');
        container.appendChild(newCard);
        setTimeout(() => {
            if(oldCard) { oldCard.classList.remove('active-card'); oldCard.classList.add('slide-out'); }
            newCard.classList.remove('slide-in'); newCard.classList.add('active-card');
            document.getElementById('turn-info').innerText = "Tour de : " + players[currentIdx];
        }, 50);
        setTimeout(() => { if(oldCard) oldCard.remove(); isAnimating = false; }, 650);
    }
</script>
</body>
</html>
